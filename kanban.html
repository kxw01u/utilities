<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board v27</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%232563eb'><rect x='10' y='10' width='20' height='80' rx='5'/><rect x='40' y='10' width='20' height='80' rx='5'/><rect x='70' y='10' width='20' height='80' rx='5'/></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* Hide scrollbar for color picker but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useCallback } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            LayoutDashboard, 
            FolderKanban, 
            Plus, 
            Search, 
            X, 
            Check, 
            RotateCcw, 
            Trash2, 
            Calendar, 
            Clock, 
            User, 
            Briefcase, 
            Layers, 
            KanbanSquare, 
            Palette, 
            CheckCircle2, 
            TrendingUp, 
            Activity, 
            PieChart, 
            ArrowRight, 
            CornerDownRight, 
            Circle, 
            Download, 
            Upload, 
            AlertCircle, 
            ExternalLink, 
            Sparkles, 
            AlignLeft, 
            GripVertical,
            ChevronDown,
            ChevronRight,
            Maximize2,
            Minimize2,
            Save
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- Utility Functions ---

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const formatDate = (dateString) => {
        if (!dateString) return '-';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '-';

        if (dateString.includes('-') && dateString.length === 10) {
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const localDate = new Date(parts[0], parts[1] - 1, parts[2]);
                return localDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
            }
        }
        return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
        };

        const calculateAge = (dateString) => {
        if (!dateString) return 0;
        const created = new Date(dateString);
        if (isNaN(created.getTime())) return 0; // Fixed: using created instead of date
        const now = new Date();
        const diffTime = Math.abs(now - created);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
        };

        const getEndFromEffort = (start, effort) => {
        if (!start || !effort) return '';
        const date = new Date(start);
        if (isNaN(date.getTime())) return '';

        if (effort.includes('d')) date.setDate(date.getDate() + parseInt(effort));
        else if (effort.includes('w')) date.setDate(date.getDate() + (parseInt(effort) * 7));
        else if (effort.includes('m')) date.setMonth(date.getMonth() + parseInt(effort));
        else date.setDate(date.getDate() + 1);

        return date.toISOString().split('T')[0];
        };

        const isDateInCurrentWeek = (dateString) => {
        if (!dateString) return false;
        let d;
        if (dateString.length === 10 && dateString.includes('-')) {
            const [y, m, day] = dateString.split('-').map(Number);
            d = new Date(y, m - 1, day);
        } else {
            d = new Date(dateString);
        }
        if (isNaN(d.getTime())) return false;
        d.setHours(0,0,0,0);
        const today = new Date();
        today.setHours(0,0,0,0);
        const dayOfWeek = today.getDay();
        const diffToSun = dayOfWeek;
        const sunday = new Date(today);
        sunday.setDate(today.getDate() - diffToSun);
        sunday.setHours(0,0,0,0);
        const saturday = new Date(sunday);
        saturday.setDate(sunday.getDate() + 6);
        saturday.setHours(23,59,59,999);
        return d >= sunday && d <= saturday;
        };

        const isTaskLeaf = (index, allTasks) => {
        if (index === allTasks.length - 1) return true;
        const currentLevel = allTasks[index].level || 0;
        const nextLevel = allTasks[index + 1].level || 0;
        return nextLevel <= currentLevel;
        };

        // --- Constants ---

        const PRIORITY_CONFIG = {
        '1': { label: 'Urgent', color: 'bg-red-100 text-red-700 border-red-200', dot: 'bg-red-500', selectColor: 'bg-red-500' },
        '2': { label: 'High', color: 'bg-purple-100 text-purple-700 border-purple-200', dot: 'bg-purple-500', selectColor: 'bg-purple-500' },
        '3': { label: 'Normal', color: 'bg-blue-100 text-blue-700 border-blue-200', dot: 'bg-blue-500', selectColor: 'bg-blue-500' },
        '4': { label: 'Low', color: 'bg-emerald-100 text-emerald-700 border-emerald-200', dot: 'bg-emerald-500', selectColor: 'bg-emerald-500' },
        };

        const WEIGHT_CONFIG = {
        'light': { label: 'Light', color: 'bg-green-50 text-green-700 border-green-200', fill: 'bg-green-500', border: 'border-green-500' },
        'medium': { label: 'Medium', color: 'bg-yellow-50 text-yellow-700 border-yellow-200', fill: 'bg-yellow-500', border: 'border-yellow-500' },
        'heavy': { label: 'Heavy', color: 'bg-orange-50 text-orange-800 border-orange-200', fill: 'bg-orange-600', border: 'border-orange-600' },
        };

        // UNIFIED COLOR PALETTE (Mapping Backgrounds for Projects and Lines for Tasks)
        const COLOR_PALETTE = [
            { id: 'white',  bg: 'bg-white',      border: 'border-gray-200',   line: 'bg-gray-400' },
            { id: 'gray',   bg: 'bg-gray-100',   border: 'border-gray-300',   line: 'bg-gray-600' },
            { id: 'red',    bg: 'bg-red-100',    border: 'border-red-200',    line: 'bg-red-600' },
            { id: 'orange', bg: 'bg-orange-100', border: 'border-orange-200', line: 'bg-orange-600' },
            { id: 'amber',  bg: 'bg-amber-100',  border: 'border-amber-200',  line: 'bg-amber-600' },
            { id: 'yellow', bg: 'bg-yellow-100', border: 'border-yellow-200', line: 'bg-yellow-500' },
            { id: 'green',  bg: 'bg-green-100',  border: 'border-green-200',  line: 'bg-green-600' },
            { id: 'emerald',bg: 'bg-emerald-100',border: 'border-emerald-200',line: 'bg-emerald-600' },
            { id: 'teal',   bg: 'bg-teal-100',   border: 'border-teal-200',   line: 'bg-teal-600' },
            { id: 'cyan',   bg: 'bg-cyan-100',   border: 'border-cyan-200',   line: 'bg-cyan-600' },
            { id: 'blue',   bg: 'bg-blue-100',   border: 'border-blue-200',   line: 'bg-blue-600' },
            { id: 'indigo', bg: 'bg-indigo-100', border: 'border-indigo-200', line: 'bg-indigo-600' },
            { id: 'violet', bg: 'bg-violet-100', border: 'border-violet-200', line: 'bg-violet-600' },
            { id: 'purple', bg: 'bg-purple-100', border: 'border-purple-200', line: 'bg-purple-600' },
            { id: 'fuchsia',bg: 'bg-fuchsia-100',border: 'border-fuchsia-200',line: 'bg-fuchsia-600' },
            { id: 'pink',   bg: 'bg-pink-100',   border: 'border-pink-200',   line: 'bg-pink-600' },
            { id: 'rose',   bg: 'bg-rose-100',   border: 'border-rose-200',   line: 'bg-rose-600' }
        ];

        // Compatibility Helper: Map background colors to border colors for legacy lookups
        const PROJECT_BORDER_COLORS = COLOR_PALETTE.reduce((acc, item) => {
            acc[item.bg] = item.border;
            return acc;
        }, {});

        // --- Sub-Components ---

        // Updated Color Picker: Topmost Layer, Grid Layout
        const ColorPicker = ({ onSelect, onClose, type = 'line' }) => {
            return (
                <React.Fragment>
                {/* Backdrop to close on click-outside */}
                <div
                    className="fixed inset-0 z-[100]"
                    onMouseDown={(e) => { e.stopPropagation(); onClose(); }}
                ></div>
                
                {/* Picker Container */}
                <div
                    className="absolute z-[101] mt-2 p-3 bg-white rounded-lg shadow-2xl border border-gray-200 grid grid-cols-5 gap-2 animate-in fade-in zoom-in-95 duration-100"
                    onMouseDown={(e) => e.stopPropagation()}
                    style={{ 
                        // Basic positioning - in a real app might need Popper.js, 
                        // but this ensures it usually pops nicely near the button
                        left: type === 'bg' ? '100%' : 'auto', 
                        right: type === 'line' ? '0' : 'auto', 
                        marginLeft: type === 'bg' ? '8px' : '0',
                        width: 'max-content' 
                    }}
                >
                    {COLOR_PALETTE.map((c) => {
                        const displayClass = type === 'bg' ? c.bg : c.line;
                        const valueToReturn = type === 'bg' ? c.bg : c.line;
                        
                        return (
                            <button
                                key={c.id}
                                onMouseDown={(e) => e.stopPropagation()}
                                onClick={(e) => {
                                    e.stopPropagation();
                                    e.nativeEvent.stopImmediatePropagation();
                                    onSelect(valueToReturn);
                                    onClose();
                                }}
                                className={`w-6 h-6 rounded-full ${displayClass} hover:scale-110 transition-transform border border-black/10 shadow-sm shrink-0 cursor-pointer`}
                                title={c.id}
                            />
                        );
                    })}
                </div>
                </React.Fragment>
            );
        };

        const DonutChart = ({ data, size = 120, showLegend = true }) => {
        let accumulatedAngle = 0;
        const total = data.reduce((acc, curr) => acc + curr.value, 0);

        if (total === 0) return (
            <div className={`flex items-center justify-center bg-gray-50 rounded-full mx-auto text-gray-400 text-xs`} style={{ width: size, height: size }}>
            No Data
            </div>
        );

        return (
            <div className={`flex ${showLegend ? 'items-center justify-center gap-6' : 'flex-col items-center'}`}>
            <div className="relative shrink-0" style={{ width: size, height: size }}>
                <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                {data.map((slice, index) => {
                    if (slice.value === 0) return null;
                    const percentage = slice.value / total;
                    const angle = percentage * 360;
                    const largeArcFlag = percentage > 0.5 ? 1 : 0;
                    const startX = 50 + 50 * Math.cos((Math.PI * accumulatedAngle) / 180);
                    const startY = 50 + 50 * Math.sin((Math.PI * accumulatedAngle) / 180);
                    accumulatedAngle += angle;
                    const endX = 50 + 50 * Math.cos((Math.PI * accumulatedAngle) / 180);
                    const endY = 50 + 50 * Math.sin((Math.PI * accumulatedAngle) / 180);

                    return (
                    <path
                        key={index}
                        d={`M 50 50 L ${startX} ${startY} A 50 50 0 ${largeArcFlag} 1 ${endX} ${endY} Z`}
                        fill={slice.color}
                        stroke="white"
                        strokeWidth="1"
                    />
                    );
                })}
                <circle cx="50" cy="50" r="30" fill="white" />
                </svg>
                <div className="absolute inset-0 flex items-center justify-center flex-col">
                <span className="text-xl font-bold text-gray-700">{total}</span>
                </div>
            </div>

            {showLegend && (
                <div className="space-y-1">
                {data.map((slice, index) => (
                    <div key={index} className="flex items-center gap-2 text-xs text-gray-600">
                    <div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: slice.color }}></div>
                    <span className="truncate max-w-[100px]" title={slice.label}>{slice.label}</span>
                    <span className="font-bold text-gray-400">({slice.value})</span>
                    </div>
                ))}
                </div>
            )}
            </div>
        );
        };

        const TaskCard = ({ task, onEdit, onDelete, onStatusChange, onColorChange, isColorPickerOpen, toggleColorPicker, onDropOnTask }) => {
        const priority = PRIORITY_CONFIG[task.priority] || PRIORITY_CONFIG['3'];
        const weightKey = task.weight || 'light';
        const weight = WEIGHT_CONFIG[weightKey] || WEIGHT_CONFIG['light'];

        const handleDragStart = (e) => {
            e.dataTransfer.setData('taskId', task.id);
            e.dataTransfer.effectAllowed = 'move';
        };

        const handleDragOver = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        const handleDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const droppedTaskId = e.dataTransfer.getData('taskId');
            if (droppedTaskId && droppedTaskId !== task.id) {
            onDropOnTask(droppedTaskId, task.id);
            }
        };

        const getTargetDateColor = (targetDate, status) => {
            if (!targetDate || status === 'done' || status === 'cancel') return '';

            const today = new Date();
            const offset = today.getTimezoneOffset();
            const todayLocal = new Date(today.getTime() - (offset*60*1000));
            const todayStr = todayLocal.toISOString().split('T')[0];

            const nextWeek = new Date(todayLocal);
            nextWeek.setDate(todayLocal.getDate() + 7);
            const nextWeekStr = nextWeek.toISOString().split('T')[0];

            if (targetDate < todayStr) {
            return 'text-red-600 font-bold';
            } else if (targetDate <= nextWeekStr) {
            return 'text-blue-600 font-bold';
            }
            return '';
        };

        const targetDateColor = getTargetDateColor(task.targetDate, task.status);
        const indentLevel = Math.min(task.level || 0, 9);
        const indentStyle = { marginLeft: `${indentLevel * 20}px` };

        return (
            <div
            draggable
            onDragStart={handleDragStart}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
            onClick={(e) => {
                e.stopPropagation();
                onEdit(task);
            }}
            style={indentStyle}
            className={`group bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all cursor-pointer mb-1 active:scale-95 select-none relative overflow-visible flex ${indentLevel > 0 ? 'mt-1 border-l-4 border-l-blue-100' : ''}`}
            >
            {indentLevel > 0 && (
                <div className="absolute -left-3 top-3 text-gray-300">
                <CornerDownRight size={12} />
                </div>
            )}

            <div className={`w-1.5 shrink-0 ${task.lineColor || 'bg-gray-400'} ${indentLevel === 0 ? 'rounded-l-lg' : ''}`}></div>

            <div className="p-3 flex-1 overflow-hidden relative">
                <div className="flex justify-between items-start mb-2">
                <div className="flex items-center gap-2">
                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium flex items-center gap-1 border ${priority.color}`}>
                    <div className={`w-1.5 h-1.5 rounded-full ${priority.dot}`}></div>
                    {priority.label}
                    {indentLevel > 0 && <span className="text-gray-400 ml-1">L{indentLevel}</span>}
                    </span>
                    {/* Weight Badge Style */}
                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium flex items-center gap-1 border ${weight.color}`}>
                        {weight.label}
                    </span>
                </div>

                <div className="flex gap-1 items-center relative z-[60]">
                    <div className="relative">
                        <button
                        onMouseDown={(e) => e.stopPropagation()}
                        onClick={(e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            toggleColorPicker(task.id);
                        }}
                        className="p-1 hover:bg-gray-100 rounded-full text-gray-400 transition-all opacity-0 group-hover:opacity-100 z-30"
                        title="Change Line Color"
                        >
                        <Palette size={12} />
                        </button>
                        {isColorPickerOpen && (
                            <ColorPicker
                                onSelect={(c) => onColorChange(task.id, c)}
                                onClose={() => toggleColorPicker(null)}
                                type="line"
                            />
                        )}
                    </div>

                    {task.assignee && (
                    <div className="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-600 border border-gray-200">
                        {task.assignee.substring(0, 2).toUpperCase()}
                    </div>
                    )}
                </div>
                </div>

                <div className="flex items-center gap-2 mb-1">
                <h4 className="text-sm font-semibold text-gray-800 leading-snug truncate">{task.name}</h4>
                {task.externalRef && (
                    <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded flex items-center gap-0.5">
                    <ExternalLink size={8}/> {task.externalRef}
                    </span>
                )}
                </div>

                {/* Display Description (Truncated) */}
                {task.description && (
                <div className="text-[10px] text-gray-600 mb-2 line-clamp-2 leading-relaxed">
                    {task.description}
                </div>
                )}

                <div className="text-[10px] text-gray-500 mb-1 font-mono whitespace-nowrap overflow-hidden text-ellipsis flex items-center gap-2">
                <span>C:{formatDate(task.createdAt)}</span>
                <span>S:{formatDate(task.start)}</span>
                <span className={`${targetDateColor}`}>T:{formatDate(task.targetDate)}</span>
                {task.status === 'done' && <span className="text-green-600 font-bold">E:{formatDate(task.end)}</span>}
                <span className="text-gray-400">| Age:{calculateAge(task.createdAt)}d</span>
                {task.effort && <span className="text-blue-500">| Est:{task.effort}</span>}
                </div>

                <div className="flex gap-1 bg-white pl-2 absolute bottom-2 right-2 z-40 shadow-sm border border-gray-100 rounded-md p-0.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none group-hover:pointer-events-auto">
                {(task.status === 'todo' || task.status === 'wip') && (
                    <>
                    <button
                        onMouseDown={(e) => e.stopPropagation()}
                        onClick={(e) => {
                        e.stopPropagation();
                        e.nativeEvent.stopImmediatePropagation();
                        e.preventDefault();
                        onStatusChange(task.id, 'done');
                        }}
                        className="p-1.5 hover:bg-green-100 text-green-600 rounded-md transition-colors" title="Complete"
                    >
                        <Check size={14} />
                    </button>
                    <button
                        onMouseDown={(e) => e.stopPropagation()}
                        onClick={(e) => {
                        e.stopPropagation();
                        e.nativeEvent.stopImmediatePropagation();
                        e.preventDefault();
                        onStatusChange(task.id, 'cancel');
                        }}
                        className="p-1.5 hover:bg-gray-100 text-gray-600 rounded-md transition-colors" title="Cancel"
                    >
                        <X size={14} />
                    </button>
                    </>
                )}
                {(task.status === 'done' || task.status === 'cancel') && (
                    <button
                    onMouseDown={(e) => e.stopPropagation()}
                    onClick={(e) => {
                        e.stopPropagation();
                        e.nativeEvent.stopImmediatePropagation();
                        e.preventDefault();
                        onStatusChange(task.id, 'todo');
                    }}
                    className="p-1.5 hover:bg-blue-100 text-blue-600 rounded-md transition-colors" title="Reopen"
                    >
                    <RotateCcw size={14} />
                    </button>
                )}
                <button
                    onMouseDown={(e) => e.stopPropagation()}
                    onClick={(e) => {
                    e.stopPropagation();
                    e.nativeEvent.stopImmediatePropagation();
                    e.preventDefault();
                    onDelete(task.id);
                    }}
                    className="p-1.5 hover:bg-red-100 text-red-600 rounded-md transition-colors" title="Delete"
                >
                    <Trash2 size={14} />
                </button>
                </div>
            </div>
            </div>
        );
        };

        // 3. Column Component with Vertical Separator
        const KanbanColumn = ({ 
        title, 
        status, 
        tasks, 
        color, 
        onDropTask, 
        onEditTask, 
        onDeleteTask, 
        onStatusChange, 
        onColorChange,
        projectId,
        activeColorPickerId,
        setActiveColorPickerId,
        onQuickAdd,
        onDropOnTask,
        isLast
        }) => {
        const [isQuickAdding, setIsQuickAdding] = useState(false);
        const [qName, setQName] = useState('');
        const [qDescription, setQDescription] = useState(''); 
        const [qPIC, setQPIC] = useState('');
        const [qPriority, setQPriority] = useState('3');
        const [qWeight, setQWeight] = useState('light');
        const [qStart, setQStart] = useState(new Date().toISOString().split('T')[0]);
        const [qEffort, setQEffort] = useState('');

        const nameInputRef = useRef(null);

        const handleDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        };

        const handleDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const taskId = e.dataTransfer.getData('taskId');
            if (taskId) onDropTask(taskId, status, projectId);
        };

        const handleBackgroundClick = (e) => {
            if (status === 'todo' && !isQuickAdding) {
            if (e.target === e.currentTarget || e.target.classList.contains('min-h-[100px]')) {
                setIsQuickAdding(true);
                setQName('');
                setQDescription('');
                setQPIC('');
                setQPriority('3');
                setQWeight('light');
                setQStart(new Date().toISOString().split('T')[0]);
                setQEffort('');
                setTimeout(() => nameInputRef.current?.focus(), 50);
            }
            }
        };

        const handleQuickAddSubmit = () => {
            if (qName.trim()) {
            onQuickAdd(projectId, {
                name: qName.trim(),
                description: qDescription.trim(),
                pic: qPIC.trim(),
                priority: qPriority,
                weight: qWeight,
                start: qStart,
                effort: qEffort
            });
            setQName('');
            setQDescription('');
            setQPIC('');
            setQEffort('');
            setIsQuickAdding(false);
            }
        };

        const handleCancelQuickAdd = () => {
            setIsQuickAdding(false);
            setQName('');
            setQDescription('');
        };

        return (
            <div 
            className={`flex-1 min-w-[280px] flex flex-col h-full bg-white/40 backdrop-blur-sm transition-colors hover:bg-white/60 ${!isLast ? 'border-r border-gray-200' : ''}`}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
            onClick={handleBackgroundClick}
            >
            <div className={`flex items-center justify-between p-2 rounded-t-lg border-b-2 ${color} bg-white/60`}>
                <h3 className="font-bold text-gray-700 text-xs uppercase tracking-wide">{title}</h3>
                <span className="bg-gray-200 text-gray-600 text-[10px] font-bold px-1.5 py-0.5 rounded-full">{tasks.length}</span>
            </div>

            <div className="flex-1 p-2 min-h-[100px] flex flex-col gap-0">
                {tasks.map(task => (
                <TaskCard 
                    key={task.id} 
                    task={task} 
                    onEdit={onEditTask} 
                    onDelete={onDeleteTask}
                    onStatusChange={onStatusChange}
                    onColorChange={onColorChange}
                    isColorPickerOpen={activeColorPickerId === task.id}
                    toggleColorPicker={(id) => setActiveColorPickerId(id === activeColorPickerId ? null : id)}
                    onDropOnTask={onDropOnTask}
                />
                ))}

                {isQuickAdding && (
                <div className="bg-white p-3 rounded-lg shadow-md border border-blue-400 mb-2 animate-in fade-in duration-200 flex flex-col gap-2" onClick={(e) => e.stopPropagation()}>
                    <input 
                    ref={nameInputRef}
                    type="text" 
                    className="w-full text-sm font-semibold outline-none border-b border-gray-100 pb-1"
                    placeholder="Task Name"
                    value={qName}
                    onChange={(e) => setQName(e.target.value)}
                    onKeyDown={(e) => { if(e.key === 'Enter') handleQuickAddSubmit(); if(e.key === 'Escape') handleCancelQuickAdd(); }}
                    />
                    
                    <textarea 
                        className="w-full text-xs text-gray-600 outline-none border-b border-gray-100 pb-1 resize-none h-auto min-h-[1.5em]"
                        placeholder="Description (optional)"
                        rows={1}
                        value={qDescription}
                        onChange={(e) => setQDescription(e.target.value)}
                        onKeyDown={(e) => { 
                            if(e.key === 'Enter' && e.ctrlKey) handleQuickAddSubmit(); 
                            if(e.key === 'Escape') handleCancelQuickAdd();
                        }}
                    />

                    <div className="flex flex-wrap items-center gap-2 bg-gray-50 p-2 rounded border border-gray-100">
                    <div className="flex flex-col gap-1 border-r border-gray-200 pr-2">
                        <label className="text-[10px] font-bold text-gray-400 uppercase">Priority</label>
                        <div className="flex gap-1">
                        {Object.entries(PRIORITY_CONFIG).map(([key, config]) => (
                            <button 
                            key={key} 
                            type="button"
                            onClick={() => setQPriority(key)}
                            className={`w-4 h-4 rounded-full flex items-center justify-center transition-all ${config.selectColor} ${qPriority === key ? 'ring-1 ring-offset-1 ring-gray-400 scale-110' : 'opacity-40 hover:opacity-100'}`}
                            title={config.label}
                            />
                        ))}
                        </div>
                    </div>

                    <div className="flex flex-col gap-1 border-r border-gray-200 pr-2">
                        <label className="text-[10px] font-bold text-gray-400 uppercase">Weight</label>
                        <div className="flex gap-1">
                        {Object.entries(WEIGHT_CONFIG).map(([key, config]) => (
                            <button 
                            key={key} 
                            type="button"
                            onClick={() => setQWeight(key)}
                            className={`w-4 h-4 rounded-full flex items-center justify-center transition-all border border-gray-200 ${config.fill} ${qWeight === key ? 'ring-1 ring-offset-1 ring-gray-400 scale-110' : 'opacity-40 hover:opacity-100'}`}
                            title={config.label}
                            />
                        ))}
                        </div>
                    </div>

                    <div className="flex-1 min-w-[60px] flex flex-col gap-1">
                        <label className="text-[10px] font-bold text-gray-400 uppercase">PIC</label>
                        <div className="flex items-center gap-1">
                            <User size={12} className="text-gray-400"/>
                            <input 
                                type="text"
                                className="w-full text-xs bg-transparent outline-none text-gray-700 border-b border-transparent focus:border-blue-300 placeholder-gray-300"
                                placeholder="Name"
                                value={qPIC}
                                onChange={(e) => setQPIC(e.target.value)}
                                onKeyDown={(e) => { if(e.key === 'Enter') handleQuickAddSubmit(); }}
                            />
                        </div>
                    </div>
                    </div>
                    
                    <div className="flex items-center gap-2">
                    <input 
                        type="date" 
                        className="text-xs bg-gray-50 border rounded p-1 w-24 shrink-0" 
                        value={qStart}
                        onChange={(e) => setQStart(e.target.value)}
                    />
                    
                    <input 
                        type="text" 
                        className="flex-1 text-xs bg-gray-50 border rounded p-1 min-w-[60px]"
                        placeholder="Effort"
                        value={qEffort}
                        onChange={(e) => setQEffort(e.target.value)}
                        onKeyDown={(e) => { if(e.key === 'Enter') handleQuickAddSubmit(); }}
                    />

                    <button 
                        onClick={handleQuickAddSubmit}
                        className="bg-blue-600 text-white rounded p-1 hover:bg-blue-700 shrink-0"
                    >
                        <Plus size={16} />
                    </button>
                    </div>
                </div>
                )}

                {tasks.length === 0 && !isQuickAdding && (
                <div className="h-full flex items-center justify-center text-gray-400 text-xs italic min-h-[80px] pointer-events-none">
                    {status === 'todo' ? 'Click here to add task' : 'Empty'}
                </div>
                )}
            </div>
            </div>
        );
        };

        // 4. Task Modal with Drag-and-Drop Form Reordering
        const TaskModal = ({ isOpen, onClose, task, onSave }) => {
        if (!isOpen) return null;

        const [formData, setFormData] = useState({
            name: '', assignee: '', externalRef: '', priority: '3', weight: 'light',
            start: new Date().toISOString().split('T')[0], targetDate: '', effort: '',
            description: '', lineColor: 'bg-gray-400'
        });

        // Form Layout State (Persistence)
        const [formOrder, setFormOrder] = useState(() => {
            const saved = localStorage.getItem('kanban_form_layout');
            // Default: Description is now second
            return saved ? JSON.parse(saved) : ['name', 'description', 'pic_ref', 'priority_weight', 'dates'];
        });

        const [draggedItem, setDraggedItem] = useState(null);

        useEffect(() => {
            if (task) {
            setFormData({
                name: task.name || '',
                assignee: task.assignee || '',
                externalRef: task.externalRef || '',
                priority: task.priority || '3',
                weight: task.weight || 'light',
                start: task.start || new Date().toISOString().split('T')[0],
                targetDate: task.targetDate || '',
                effort: task.effort || '',
                description: task.description || '',
                lineColor: task.lineColor || 'bg-gray-400'
            });
            } else {
            setFormData({
                name: '', assignee: '', externalRef: '', priority: '3', weight: 'light',
                start: new Date().toISOString().split('T')[0], targetDate: '', effort: '',
                description: '', lineColor: 'bg-gray-400'
            });
            }
        }, [task, isOpen]);

        useEffect(() => {
            if (formData.start && formData.effort) {
            const newTarget = getEndFromEffort(formData.start, formData.effort);
            setFormData(prev => ({ ...prev, targetDate: newTarget }));
            }
        }, [formData.start, formData.effort]);

        const handleSubmit = (e) => {
            e.preventDefault();
            onSave(formData);
            onClose();
        };

        // Drag and Drop Logic for Form Fields
        const onDragStart = (e, index) => {
            setDraggedItem(index);
            e.dataTransfer.effectAllowed = "move";
        };

        const onDragOver = (e, index) => {
            e.preventDefault();
            if (draggedItem === null || draggedItem === index) return;
            
            const newOrder = [...formOrder];
            const item = newOrder.splice(draggedItem, 1)[0];
            newOrder.splice(index, 0, item);
            
            setDraggedItem(index);
            setFormOrder(newOrder);
        };

        const onDragEnd = () => {
            setDraggedItem(null);
            localStorage.setItem('kanban_form_layout', JSON.stringify(formOrder));
        };

        const renderField = (key) => {
            switch(key) {
                case 'name':
                    return (
                        <div>
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Task Name</label>
                            <input
                            required type="text"
                            className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                            placeholder="What needs to be done?"
                            value={formData.name}
                            onChange={e => setFormData({...formData, name: e.target.value})}
                            />
                        </div>
                    );
                case 'pic_ref':
                    return (
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">PIC</label>
                            <div className="relative">
                                <User size={14} className="absolute left-2.5 top-2.5 text-gray-400" />
                                <input
                                type="text"
                                className="w-full pl-8 p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                placeholder="Person In Charge"
                                value={formData.assignee}
                                onChange={e => setFormData({...formData, assignee: e.target.value})}
                                />
                            </div>
                            </div>
                            <div>
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">External Ref#</label>
                            <input
                                type="text"
                                className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                placeholder="e.g. JIRA-123"
                                value={formData.externalRef}
                                onChange={e => setFormData({...formData, externalRef: e.target.value})}
                            />
                            </div>
                        </div>
                    );
                case 'priority_weight':
                    return (
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Priority</label>
                                <div className="flex gap-2">
                                {Object.entries(PRIORITY_CONFIG).map(([key, config]) => (
                                    <button
                                    key={key} type="button"
                                    onClick={() => setFormData(prev => ({...prev, priority: key}))}
                                    className={`w-6 h-6 rounded-full flex items-center justify-center transition-all ${config.selectColor} ${formData.priority === key ? 'ring-2 ring-offset-2 ring-gray-400 scale-110 shadow-sm' : 'opacity-40 hover:opacity-100'}`}
                                    title={config.label}
                                    >
                                        {formData.priority === key && <div className="w-1.5 h-1.5 rounded-full bg-white" />}
                                    </button>
                                ))}
                                </div>
                            </div>
                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Weight</label>
                                <div className="flex gap-2">
                                {Object.entries(WEIGHT_CONFIG).map(([key, config]) => (
                                    <button
                                    key={key} type="button"
                                    onClick={() => setFormData(prev => ({...prev, weight: key}))}
                                    className={`w-6 h-6 rounded-full flex items-center justify-center transition-all border border-gray-200 ${config.fill} ${formData.weight === key ? 'ring-2 ring-offset-2 ring-gray-400 scale-110 shadow-sm' : 'opacity-40 hover:opacity-100'}`}
                                    title={config.label}
                                    >
                                        {formData.weight === key && <Check size={10} className="text-white" />}
                                    </button>
                                ))}
                                </div>
                            </div>
                        </div>
                    );
                case 'dates':
                    return (
                        <div className="grid grid-cols-3 gap-4">
                            <div>
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Start Date (S)</label>
                            <input
                                type="date"
                                className="w-full p-2 border rounded-md text-sm text-gray-600"
                                value={formData.start}
                                onChange={e => setFormData({...formData, start: e.target.value})}
                            />
                            </div>
                            <div>
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Effort</label>
                            <input
                                type="text"
                                className="w-full p-2 border rounded-md text-sm text-gray-600 bg-white"
                                placeholder="e.g. 2d, 1w"
                                value={formData.effort}
                                onChange={e => setFormData({...formData, effort: e.target.value})}
                            />
                            </div>
                            <div>
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Target Date (T)</label>
                            <input
                                type="date"
                                className="w-full p-2 border rounded-md text-sm text-gray-600 bg-white"
                                value={formData.targetDate}
                                onChange={e => setFormData({...formData, targetDate: e.target.value})}
                            />
                            </div>
                        </div>
                    );
                case 'description':
                    return (
                        <div>
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Description</label>
                            <textarea
                            className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm h-24 resize-none"
                            placeholder="Add details..."
                            value={formData.description}
                            onChange={e => setFormData({...formData, description: e.target.value})}
                            />
                        </div>
                    );
                default: return null;
            }
        };

        return (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                <h3 className="font-bold text-gray-800">{task ? 'Edit Task' : 'New Task'}</h3>
                <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full transition-colors">
                    <X size={20} className="text-gray-500" />
                </button>
                </div>

                <form onSubmit={handleSubmit} className="p-4 space-y-4 max-h-[80vh] overflow-y-auto">
                    {formOrder.map((key, index) => (
                        <div 
                            key={key}
                            draggable
                            onDragStart={(e) => onDragStart(e, index)}
                            onDragOver={(e) => onDragOver(e, index)}
                            onDragEnd={onDragEnd}
                            className={`transition-all ${draggedItem === index ? 'opacity-50 border-2 border-dashed border-blue-300 rounded-lg' : ''}`}
                        >
                            <div className="flex items-center gap-2 mb-1 cursor-grab active:cursor-grabbing hover:bg-gray-50 rounded px-1 -ml-1 w-fit group">
                                <GripVertical size={12} className="text-gray-300 group-hover:text-gray-500"/>
                                {renderField(key)}
                            </div>
                        </div>
                    ))}

                    {/* End date separate as it's conditional */}
                    {(task && (task.status === 'done' || task.status === 'cancel')) && (
                        <div className="mt-2">
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1 text-green-600">End Date (E)</label>
                            <input
                            type="date"
                            className="w-full p-2 border rounded-md text-sm text-gray-600 bg-white"
                            value={formData.end || ''} 
                            onChange={e => setFormData({...formData, end: e.target.value})}
                            />
                        </div>
                    )}

                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-blue-200 transition-all">
                    {task ? 'Save Changes' : 'Create Task'}
                </button>
                </form>
            </div>
            </div>
        );
        };

        // 5. Project Modal
        const ProjectModal = ({ isOpen, onClose, onSave }) => {
        const [name, setName] = useState('');
        const [color, setColor] = useState('bg-white');

        if (!isOpen) return null;

        const handleSubmit = (e) => {
            e.preventDefault();
            if (name.trim()) {
            onSave({ name, color });
            setName('');
            setColor('bg-white');
            onClose();
            }
        };

        return (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                <h3 className="font-bold text-gray-800">New Project</h3>
                <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full transition-colors">
                    <X size={20} className="text-gray-500" />
                </button>
                </div>

                <form onSubmit={handleSubmit} className="p-4 space-y-4">
                <div>
                    <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Project Name</label>
                    <input
                    required
                    type="text"
                    className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                    placeholder="e.g. Marketing Launch"
                    value={name}
                    onChange={e => setName(e.target.value)}
                    autoFocus
                    />
                </div>

                <div>
                    <label className="block text-xs font-semibold text-gray-500 uppercase mb-2">Background Color</label>
                    <div className="grid grid-cols-6 gap-2">
                    {COLOR_PALETTE.map(c => (
                        <button
                        key={c.id}
                        type="button"
                        onClick={() => setColor(c.bg)}
                        className={`w-8 h-8 rounded-full border border-gray-200 ${c.bg} ${color === c.bg ? 'ring-2 ring-blue-500 ring-offset-2' : ''}`}
                        title={c.id}
                        />
                    ))}
                    </div>
                </div>

                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-blue-200 transition-all">
                    Create Project
                </button>
                </form>
            </div>
            </div>
        );
        };

        // --- Main App Component ---

        function App() {
        const [currentView, setCurrentView] = useState('dashboard');
        const fileInputRef = useRef(null);

        // Zoom State
        const [zoomLevel, setZoomLevel] = useState(() => {
            try {
                const saved = localStorage.getItem('kanban_zoom_level');
                return saved ? parseFloat(saved) : 1;
            } catch(e) { return 1; }
        });

        useEffect(() => {
            const handleWheel = (e) => {
            if (e.ctrlKey) {
                e.preventDefault();
                setZoomLevel(prev => {
                let newZoom = prev - e.deltaY * 0.001;
                newZoom = Math.min(Math.max(0.5, newZoom), 2);
                return newZoom;
                });
            }
            };
            window.addEventListener('wheel', handleWheel, { passive: false });
            return () => window.removeEventListener('wheel', handleWheel);
        }, []);

        useEffect(() => {
            localStorage.setItem('kanban_zoom_level', zoomLevel);
            document.documentElement.style.fontSize = `${16 * zoomLevel}px`; 
        }, [zoomLevel]);

        // Data State
        const [projects, setProjects] = useState(() => {
            try {
            const saved = localStorage.getItem('kanban_data_v1');
            return saved ? JSON.parse(saved) : [{ id: 'p1', name: 'Project Alpha', color: 'bg-white', tasks: [] }];
            } catch (e) {
            return [{ id: 'p1', name: 'Project Alpha', color: 'bg-white', tasks: [] }];
            }
        });

        const [activeProjectId, setActiveProjectId] = useState(null);
        const [searchQuery, setSearchQuery] = useState('');
        const [collapsedProjects, setCollapsedProjects] = useState({}); // Map of project ID -> boolean

        // Modal State
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
        const [editingTask, setEditingTask] = useState(null);
        const [activeTaskColorPickerId, setActiveTaskColorPickerId] = useState(null);
        const [activeProjectColorPickerId, setActiveProjectColorPickerId] = useState(null);

        // Persistence
        useEffect(() => {
            localStorage.setItem('kanban_data_v1', JSON.stringify(projects));
        }, [projects]);

        // Actions
        const handleAddProject = (projectData) => {
            const newProj = {
            id: generateId(),
            name: projectData.name,
            color: projectData.color,
            tasks: []
            };
            setProjects(prev => [...prev, newProj]);
            setCurrentView('ongoing');
        };

        const handleUpdateProjectColor = (projectId, newColor) => {
            setProjects(prev => prev.map(p => p.id === projectId ? { ...p, color: newColor } : p));
        };

        const handleRenameProject = (projectId, newName) => {
            setProjects(prev => prev.map(p => p.id === projectId ? { ...p, name: newName } : p));
        };

        const toggleProjectCollapse = (projectId) => {
            setCollapsedProjects(prev => ({
                ...prev,
                [projectId]: !prev[projectId]
            }));
        };

        const toggleCollapseAll = () => {
            const allCollapsed = projects.every(p => collapsedProjects[p.id]);
            const newMap = {};
            projects.forEach(p => newMap[p.id] = !allCollapsed);
            setCollapsedProjects(newMap);
        };

        const updateProject = (projectId, updater) => {
            setProjects(prev => prev.map(p => {
            if (p.id !== projectId) return p;
            return updater(p);
            }));
        };

        const deleteTask = (taskId) => {
            if (window.confirm("Are you sure you want to delete this task?")) {
                setProjects(prev => prev.map(p => ({
                    ...p,
                    tasks: p.tasks.filter(t => t.id !== taskId)
                })));
            }
        };

        const deleteProject = (projectId) => {
            if (confirm("Are you sure you want to delete this project and all its tasks?")) {
                setProjects(prev => prev.filter(p => p.id !== projectId));
            }
        };

        const exportToCSV = (currentProjects) => {
            const headers = ['Project', 'Task Name', 'External Ref', 'Status', 'Priority', 'Weight', 'Start Date', 'End Date', 'Created Date', 'Completed Date', 'Effort', 'Level'];
            const rows = [];
            currentProjects.forEach(p => {
                p.tasks.forEach(t => {
                rows.push([
                    `"${p.name}"`, 
                    `"${t.name}"`, 
                    `"${t.externalRef||''}"`, 
                    t.status, 
                    t.priority, 
                    t.weight, 
                    t.start, 
                    t.end||'', 
                    t.createdAt, 
                    t.completedAt||'', 
                    t.effort||'', 
                    t.level||0
                ].join(','));
                });
            });
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + "\n" + rows.join('\n');
            const encodedUri = encodeURI(csvContent);
            
            // Format Filename: kanban_YYYYMMDDHHMM
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const fileName = `kanban_${yyyy}${mm}${dd}${hh}${min}.csv`;

            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const handleQuickAddTask = (projectId, taskData) => {
            if (!taskData.name || !projectId) return;
            const now = new Date().toISOString();

            let calculatedTarget = '';
            if (taskData.effort) {
            calculatedTarget = getEndFromEffort(taskData.start, taskData.effort);
            }

            updateProject(projectId, (project) => ({
            ...project,
            tasks: [...project.tasks, {
                id: generateId(),
                status: 'todo',
                name: taskData.name,
                description: taskData.description || '', 
                assignee: taskData.pic || '',
                priority: taskData.priority,
                weight: taskData.weight,
                start: taskData.start,
                effort: taskData.effort,
                targetDate: calculatedTarget,
                createdAt: now,
                projectId: projectId,
                lineColor: 'bg-gray-400',
                level: 0 
            }]
            }));
        };

        const handleSaveTask = (taskData) => {
            const targetProjectId = activeProjectId || projects[0]?.id;
            if (!targetProjectId) return;

            const now = new Date().toISOString();

            updateProject(targetProjectId, (project) => {
            if (editingTask) {
                return {
                ...project,
                tasks: project.tasks.map(t => t.id === editingTask.id ? { ...t, ...taskData } : t)
                };
            } else {
                return {
                ...project,
                tasks: [...project.tasks, {
                    ...taskData,
                    id: generateId(),
                    status: 'todo',
                    createdAt: now,
                    projectId: targetProjectId,
                    level: 0
                }]
                };
            }
            });
        };

        const findDescendants = (allTasks, parentIndex, parentLevel) => {
            const descendants = [];
            for (let i = parentIndex + 1; i < allTasks.length; i++) {
            const currentTask = allTasks[i];
            if ((currentTask.level || 0) > parentLevel) {
                descendants.push(currentTask);
            } else {
                break; 
            }
            }
            return descendants;
        };

        const updateTaskStatus = (taskId, newStatus, targetProjectId) => {
            setProjects(prev => {
            let sourceProjectIndex = -1;
            let taskIndex = -1;
            let taskToMove = null;

            for (let i = 0; i < prev.length; i++) {
                const idx = prev[i].tasks.findIndex(t => t.id === taskId);
                if (idx !== -1) {
                sourceProjectIndex = i;
                taskIndex = idx;
                taskToMove = prev[i].tasks[idx];
                break;
                }
            }

            if (!taskToMove) return prev;

            const newProjects = [...prev];
            const now = new Date().toISOString();
            const todayDate = now.split('T')[0];
            const isDone = newStatus === 'done';

            const projectTasks = newProjects[sourceProjectIndex].tasks;
            const descendants = findDescendants(projectTasks, taskIndex, taskToMove.level || 0);
            const idsToMove = [taskToMove.id, ...descendants.map(d => d.id)];

            const currentRootLevel = taskToMove.level || 0;
            const levelShift = 0 - currentRootLevel;

            if (targetProjectId && targetProjectId !== newProjects[sourceProjectIndex].id) {
                const tasksToKeep = projectTasks.filter(t => !idsToMove.includes(t.id));
                newProjects[sourceProjectIndex].tasks = tasksToKeep;

                const targetProj = newProjects.find(p => p.id === targetProjectId);

                if (targetProj) {
                idsToMove.forEach(id => {
                    const t = (id === taskToMove.id) ? taskToMove : descendants.find(d => d.id === id);
                    
                    const oldLevel = t.level || 0;
                    const newLevel = Math.max(0, oldLevel + levelShift);

                    const updatedT = {
                    ...t,
                    status: newStatus,
                    completedAt: isDone ? now : undefined,
                    end: isDone ? todayDate : t.end,
                    level: newLevel
                    };
                    targetProj.tasks.push(updatedT);
                });
                }
            } else {
                idsToMove.forEach(id => {
                const tIndex = projectTasks.findIndex(t => t.id === id);
                if (tIndex !== -1) {
                    
                    const oldLevel = projectTasks[tIndex].level || 0;
                    const newLevel = Math.max(0, oldLevel + levelShift);

                    projectTasks[tIndex] = {
                    ...projectTasks[tIndex],
                    status: newStatus,
                    completedAt: isDone ? now : undefined,
                    end: isDone ? todayDate : projectTasks[tIndex].end,
                    level: newLevel
                    };
                }
                });
            }

            return newProjects;
            });
        };

        const handleDropOnTask = (droppedTaskId, targetTaskId) => {
            setProjects(prev => {
            let sourceProjectIndex = -1;
            let taskIndex = -1;
            let taskToMove = null;

            for (let i = 0; i < prev.length; i++) {
                const idx = prev[i].tasks.findIndex(t => t.id === droppedTaskId);
                if (idx !== -1) {
                sourceProjectIndex = i;
                taskIndex = idx;
                taskToMove = prev[i].tasks[idx];
                break;
                }
            }

            if (!taskToMove) return prev;

            let targetProjectIndex = -1;
            let targetTaskIndex = -1;
            let targetTask = null;
            for (let i = 0; i < prev.length; i++) {
                const idx = prev[i].tasks.findIndex(t => t.id === targetTaskId);
                if (idx !== -1) {
                targetProjectIndex = i;
                targetTaskIndex = idx;
                targetTask = prev[i].tasks[idx];
                break;
                }
            }

            if (!targetTask) return prev;

            if (sourceProjectIndex !== targetProjectIndex || taskToMove.status !== targetTask.status) {
                return prev;
            }

            const newProjects = [...prev];
            const projectTasks = newProjects[sourceProjectIndex].tasks;

            projectTasks.splice(taskIndex, 1);

            const newLevel = Math.min((targetTask.level || 0) + 1, 9);
            const newTargetIndex = projectTasks.findIndex(t => t.id === targetTaskId);

            const updatedTask = {
                ...taskToMove,
                level: newLevel
            };

            projectTasks.splice(newTargetIndex + 1, 0, updatedTask);

            return newProjects;
            });
        };

        const updateTaskColor = (taskId, newColor) => {
            setProjects(prev => prev.map(p => ({
            ...p,
            tasks: p.tasks.map(t => t.id === taskId ? { ...t, lineColor: newColor } : t)
            })));
        };

        const openNewTaskModal = (projectId) => {
            setActiveProjectId(projectId);
            setEditingTask(null);
            setIsModalOpen(true);
        };

        const openEditTaskModal = (task) => {
            const proj = projects.find(p => p.tasks.some(t => t.id === task.id));
            if (proj) setActiveProjectId(proj.id);
            setEditingTask(task);
            setIsModalOpen(true);
        };

        const navigateToTask = (task) => {
            if (task.status === 'done' || task.status === 'cancel') {
            setCurrentView('completed');
            } else {
            setCurrentView('ongoing');
            }
        };

        const handleImportCSV = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
            const csvText = e.target.result;
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const projectsMap = {};

            const parseLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
                }
                result.push(current);
                return result.map(c => c.replace(/"/g, '').trim());
            };

            for (let i = 1; i < lines.length; i++) {
                const values = parseLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                row[header] = values[index];
                });

                const projectName = row['Project'];
                if (!projectName) continue;

                if (!projectsMap[projectName]) {
                projectsMap[projectName] = {
                    id: generateId(),
                    name: projectName,
                    color: 'bg-white',
                    tasks: []
                };
                }

                projectsMap[projectName].tasks.push({
                id: generateId(),
                name: row['Task Name'],
                externalRef: row['External Ref'] || '',
                status: row['Status'] || 'todo',
                priority: row['Priority'] || '3',
                weight: row['Weight'] || 'light',
                start: row['Start Date'] || '',
                end: row['End Date'] || '',
                createdAt: row['Created Date'] || new Date().toISOString(),
                completedAt: row['Completed Date'] || undefined,
                effort: row['Effort'] || '',
                level: parseInt(row['Level']) || 0,
                lineColor: 'bg-gray-400'
                });
            }

            setProjects(prev => [...prev, ...Object.values(projectsMap)]);
            };
            reader.readAsText(file);
            event.target.value = null;
        };

        // --- Dashboard Statistics ---
        const stats = useMemo(() => {
            let totalProjects = projects.length;
            let totalTodo = 0;
            let totalWip = 0;
            let totalCompleted = 0;
            let createdThisWeek = 0;
            let completedThisWeek = 0;
            const assigneeTasks = {}; 
            const projectCharts = [];

            const completedTasksProjects = []; 
            const delayedTasksProjects = [];   
            const newTasksProjects = [];       

            const today = new Date();
            const offset = today.getTimezoneOffset();
            const todayLocal = new Date(today.getTime() - (offset*60*1000));
            const todayStr = todayLocal.toISOString().split('T')[0];

            projects.forEach(p => {
            let pTodo = 0;
            let pWip = 0;
            let pDone = 0;

            const weeklyDoneTasks = [];
            const delayedTasks = [];
            const weeklyNewTasks = [];

            p.tasks.forEach((t, index) => {
                const isLeaf = isTaskLeaf(index, p.tasks);
                if (!isLeaf) return;

                if (t.status === 'todo') { totalTodo++; pTodo++; }
                if (t.status === 'wip') { totalWip++; pWip++; }
                if (t.status === 'done') { totalCompleted++; pDone++; }

                if ((t.status === 'todo' || t.status === 'wip') && isDateInCurrentWeek(t.createdAt)) {
                createdThisWeek++;
                weeklyNewTasks.push(t);
                }

                if (t.status === 'done' && isDateInCurrentWeek(t.end)) {
                completedThisWeek++;
                weeklyDoneTasks.push(t);
                }

                if (t.targetDate && t.targetDate < todayStr && (t.status === 'todo' || t.status === 'wip')) {
                    delayedTasks.push(t);
                }

                if (t.assignee && (t.status === 'todo' || t.status === 'wip')) {
                if (!assigneeTasks[t.assignee]) assigneeTasks[t.assignee] = [];
                assigneeTasks[t.assignee].push(t);
                }
            });

            if (weeklyDoneTasks.length > 0) {
                completedTasksProjects.push({ ...p, tasks: weeklyDoneTasks });
            }

            if (delayedTasks.length > 0) {
                delayedTasksProjects.push({ ...p, tasks: delayedTasks });
            }

            if (weeklyNewTasks.length > 0) {
                newTasksProjects.push({ ...p, tasks: weeklyNewTasks });
            }

            if (pTodo + pWip + pDone > 0) {
                projectCharts.push({
                name: p.name,
                data: [
                    { label: 'Todo', value: pTodo, color: '#60a5fa' },
                    { label: 'WIP', value: pWip, color: '#fbbf24' },
                    { label: 'Done', value: pDone, color: '#4ade80' }
                ]
                });
            }
            });

            return {
            totalProjects,
            totalTodo,
            totalWip,
            totalCompleted,
            createdThisWeek,
            completedThisWeek,
            assigneeTasks,
            projectCharts,
            completedTasksProjects,
            delayedTasksProjects,
            newTasksProjects
            };
        }, [projects]);

        // --- Rendering ---

        const renderDashboard = () => (
            <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500 overflow-y-auto h-full">
            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                <div className="p-2 rounded-full bg-indigo-100 text-indigo-600 mb-2"><Layers size={20}/></div>
                <h3 className="text-2xl font-bold text-gray-800">{stats.totalProjects}</h3>
                <p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">Projects</p>
                </div>

                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                <div className="p-2 rounded-full bg-blue-100 text-blue-600 mb-2"><Plus size={20}/></div>
                <h3 className="text-2xl font-bold text-gray-800">{stats.createdThisWeek}</h3>
                <p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">New (this week)</p>
                </div>

                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                <div className="p-2 rounded-full bg-green-100 text-green-600 mb-2"><CheckCircle2 size={20}/></div>
                <h3 className="text-2xl font-bold text-gray-800">{stats.completedThisWeek}</h3>
                <p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">Done (this week)</p>
                </div>

                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                <div className="p-2 rounded-full bg-gray-100 text-gray-600 mb-2"><Briefcase size={20}/></div>
                <h3 className="text-2xl font-bold text-gray-800">{stats.totalTodo}</h3>
                <p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">Total To Do</p>
                </div>

                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                <div className="p-2 rounded-full bg-yellow-100 text-yellow-600 mb-2"><Activity size={20}/></div>
                <h3 className="text-2xl font-bold text-gray-800">{stats.totalWip}</h3>
                <p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">Total WIP</p>
                </div>

                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                <div className="p-2 rounded-full bg-emerald-100 text-emerald-600 mb-2"><Check size={20}/></div>
                <h3 className="text-2xl font-bold text-gray-800">{stats.totalCompleted}</h3>
                <p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">Total Done</p>
                </div>
            </div>

            {/* Row 2: Project Summary & Team Workload */}
            <div className="grid grid-cols-2 gap-8">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 className="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2"><PieChart size={18}/> Project summary</h3>

                {stats.projectCharts.length > 0 ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-2 gap-6">
                    {stats.projectCharts.map(pc => (
                        <div key={pc.name} className="flex flex-col items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 className="font-semibold text-gray-700 mb-4 truncate w-full text-center" title={pc.name}>{pc.name}</h4>
                        <DonutChart data={pc.data} size={100} showLegend={false} />
                        <div className="mt-4 w-full grid grid-cols-3 gap-1 text-[10px] text-center text-gray-500">
                            <div className="bg-blue-100 py-1 rounded text-blue-700">T: {pc.data[0].value}</div>
                            <div className="bg-yellow-100 py-1 rounded text-yellow-700">W: {pc.data[1].value}</div>
                            <div className="bg-green-100 py-1 rounded text-green-700">D: {pc.data[2].value}</div>
                        </div>
                        </div>
                    ))}
                    </div>
                ) : (
                    <div className="text-center py-10 text-gray-400 italic">No project data available</div>
                )}
                </div>

                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 className="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2"><User size={18}/> Team Workload</h3>
                {Object.keys(stats.assigneeTasks).length === 0 ? (
                    <div className="flex h-40 items-center justify-center text-gray-400 italic">No active tasks assigned</div>
                ) : (
                    <div className="flex flex-col gap-4">
                    {Object.entries(stats.assigneeTasks).map(([name, tasks]) => {
                        // Sort by weight
                        const sortedTasks = [...tasks].sort((a, b) => {
                            const wa = a.weight || 'light';
                            const wb = b.weight || 'light';
                            const valA = wa === 'heavy' ? 3 : wa === 'medium' ? 2 : 1;
                            const valB = wb === 'heavy' ? 3 : wb === 'medium' ? 2 : 1;
                            return valB - valA;
                        });

                        const score = tasks.reduce((acc, t) => {
                            const w = t.weight || 'light';
                            return acc + (w === 'heavy' ? 3 : w === 'medium' ? 2 : 1);
                        }, 0);
                        return { name, tasks: sortedTasks, score };
                    })
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 8)
                    .map(({ name, tasks }) => (
                        <div key={name} className="flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center text-xs font-bold text-gray-600 border border-gray-200 shrink-0">
                            {name.substring(0,2).toUpperCase()}
                        </div>
                        <div className="flex-1 flex flex-col justify-center">
                            <div className="flex justify-between text-sm mb-1">
                            <span className="font-medium text-gray-700">{name}</span>
                            <span className="text-gray-500 text-xs">{tasks.length} tasks</span>
                            </div>
                            {/* Linear Bar Composition */}
                            <div className="flex h-3 w-full bg-gray-200 rounded-full overflow-hidden">
                                {tasks.map(t => {
                                    const w = t.weight || 'light';
                                    const widthClass = w === 'heavy' ? 'w-9' : w === 'medium' ? 'w-6' : 'w-3';
                                    const colorClass = w === 'heavy' ? 'bg-red-600' : w === 'medium' ? 'bg-purple-500' : 'bg-green-500';

                                    return (
                                        <div 
                                            key={t.id} 
                                            className={`h-full border-r border-white/20 last:border-0 ${widthClass} ${colorClass} shrink-0`}
                                            title={`${t.name} (${w})`}
                                        />
                                    )
                                })}
                            </div>
                        </div>
                        </div>
                    ))}
                    </div>
                )}
                </div>
            </div>

            {/* Row 3: New Tasks */}
            <div className="mt-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-gray-700 flex items-center gap-2">
                            <Sparkles size={18} className="text-blue-500"/> New Tasks (this week)
                        </h3>
                    </div>

                    {stats.newTasksProjects.length === 0 ? (
                        <p className="text-gray-400 text-sm italic">No new tasks this week.</p>
                    ) : (
                        <div className="grid grid-cols-2 gap-6">
                            <div>
                                <h4 className="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-blue-500"></div> To Do
                                </h4>
                                {stats.newTasksProjects.map(p => {
                                    const tasks = p.tasks.filter(t => t.status === 'todo');
                                    if (tasks.length === 0) return null;
                                    const borderColorClass = PROJECT_BORDER_COLORS[p.color] || 'border-gray-200';
                                    return (
                                        <div key={p.id} className={`mb-4 pl-3 border-l-4 ${borderColorClass}`}>
                                            <div className="text-xs font-bold text-gray-700 mb-1">{p.name}</div>
                                            {tasks.map(t => (
                                                <div key={t.id} className="bg-gray-50 p-2 mb-1 rounded text-sm border border-gray-100 text-gray-600">
                                                    {t.name}
                                                </div>
                                            ))}
                                        </div>
                                    )
                                })}
                            </div>
                            <div>
                                <h4 className="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-yellow-500"></div> In Progress
                                </h4>
                                {stats.newTasksProjects.map(p => {
                                    const tasks = p.tasks.filter(t => t.status === 'wip');
                                    if (tasks.length === 0) return null;
                                    const borderColorClass = PROJECT_BORDER_COLORS[p.color] || 'border-gray-200';
                                    return (
                                        <div key={p.id} className={`mb-4 pl-3 border-l-4 ${borderColorClass}`}>
                                            <div className="text-xs font-bold text-gray-700 mb-1">{p.name}</div>
                                            {tasks.map(t => (
                                                <div key={t.id} className="bg-gray-50 p-2 mb-1 rounded text-sm border border-gray-100 text-gray-600">
                                                    {t.name}
                                                </div>
                                            ))}
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    )}
                </div>

                {/* Row 4: Delayed & Completed */}
                <div className="grid grid-cols-2 gap-8 mt-8">
                    {/* Tasks Delayed Table */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-700 flex items-center gap-2">
                                <AlertCircle size={18} className="text-red-500"/> Tasks Delayed
                            </h3>
                        </div>

                        {stats.delayedTasksProjects.length === 0 ? (
                            <p className="text-gray-400 text-sm italic">No tasks delayed.</p>
                        ) : (
                            <div className="space-y-4">
                            {stats.delayedTasksProjects.map(p => (
                                renderProjectRow(p, [
                                    { title: 'Delayed', status: 'delayed', statuses: ['todo', 'wip'] }
                                ])
                            ))}
                            </div>
                        )}
                    </div>

                    {/* Completed tasks in this week */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-700 flex items-center gap-2">
                                <CheckCircle2 size={18} /> Completed Task (this week)
                            </h3>
                        </div>

                        {stats.completedTasksProjects.length === 0 ? (
                            <p className="text-gray-400 text-sm italic">No tasks completed this week.</p>
                        ) : (
                            <div className="space-y-4">
                            {stats.completedTasksProjects.map(p => (
                                renderProjectRow(p, [
                                    { title: 'Completed (This Week)', status: 'done', statuses: ['done'] }
                                ])
                            ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );

        const renderProjectRow = (project, columns) => {
            const todoCount = project.tasks.filter(t => t.status === 'todo' && isTaskLeaf(project.tasks.indexOf(t), project.tasks)).length;
            const wipCount = project.tasks.filter(t => t.status === 'wip' && isTaskLeaf(project.tasks.indexOf(t), project.tasks)).length;
            const doneCount = project.tasks.filter(t => t.status === 'done' && isTaskLeaf(project.tasks.indexOf(t), project.tasks)).length;
            
            // Stats for summary row
            const urgentCount = project.tasks.filter(t => t.priority === '1' && (t.status === 'todo' || t.status === 'wip')).length;
            const highCount = project.tasks.filter(t => t.priority === '2' && (t.status === 'todo' || t.status === 'wip')).length;
            const normalCount = project.tasks.filter(t => t.priority === '3' && (t.status === 'todo' || t.status === 'wip')).length;
            const lowCount = project.tasks.filter(t => t.priority === '4' && (t.status === 'todo' || t.status === 'wip')).length;

            const heavyCount = project.tasks.filter(t => t.weight === 'heavy' && (t.status === 'todo' || t.status === 'wip')).length;
            const mediumCount = project.tasks.filter(t => t.weight === 'medium' && (t.status === 'todo' || t.status === 'wip')).length;
            const lightCount = project.tasks.filter(t => (t.weight === 'light' || !t.weight) && (t.status === 'todo' || t.status === 'wip')).length;

            const isMainBoard = currentView === 'ongoing' || currentView === 'completed';
            const isCollapsed = collapsedProjects[project.id] && isMainBoard;

            const gridClass = isMainBoard 
                ? `grid grid-cols-${columns.length} divide-x divide-gray-200`
                : 'grid grid-cols-1';
            
            const borderColorClass = project.color ? project.color.replace('bg-', 'border-').replace('100', '200') : 'border-gray-200';

            return (
            <div key={project.id} className={`rounded-xl shadow-sm border border-gray-200 overflow-hidden ${project.color || 'bg-white'} mb-4 ${!isMainBoard ? `border-l-4 ${borderColorClass}` : ''}`}>
                <div className="bg-white/60 p-4 border-b border-gray-200/60 flex justify-between items-center backdrop-blur-sm group">
                <div className="flex items-center gap-3">
                    {isMainBoard && (
                        <button 
                            onClick={(e) => { e.stopPropagation(); toggleProjectCollapse(project.id); }}
                            className="text-gray-400 hover:text-gray-700 transition-colors"
                        >
                            {isCollapsed ? <ChevronRight size={18} /> : <ChevronDown size={18} />}
                        </button>
                    )}
                    <h3 className="font-bold text-gray-800 flex items-center gap-2">
                        <FolderKanban size={18} className="text-blue-500"/>
                        {/* Inline Rename */}
                        <input 
                            type="text" 
                            value={project.name} 
                            onChange={(e) => handleRenameProject(project.id, e.target.value)}
                            className="bg-transparent border-none outline-none focus:ring-1 focus:ring-blue-300 rounded px-1 hover:bg-white/50 w-full max-w-[300px]"
                        />
                    </h3>
                    {isMainBoard && (
                        <div className="text-xs font-medium text-gray-500 flex gap-2 ml-4 bg-white/50 px-2 py-1 rounded-md border border-gray-100 items-center overflow-x-auto no-scrollbar max-w-[50vw]">
                        {currentView === 'ongoing' ? (
                            <>
                                <span className="whitespace-nowrap">TODO: {todoCount}</span>
                                <span className="text-gray-300">|</span>
                                <span className="whitespace-nowrap">WIP: {wipCount}</span>
                                {isCollapsed && (
                                    <>
                                        <span className="text-gray-300">|</span>
                                        <span className="text-red-600 font-bold whitespace-nowrap">Urgent: {urgentCount}</span>
                                        <span className="text-gray-300">|</span>
                                        <span className="text-purple-600 font-bold whitespace-nowrap">High: {highCount}</span>
                                        <span className="text-gray-300">|</span>
                                        <span className="text-blue-600 font-bold whitespace-nowrap">Normal: {normalCount}</span>
                                        <span className="text-gray-300">|</span>
                                        <span className="text-emerald-600 font-bold whitespace-nowrap">Low: {lowCount}</span>
                                        
                                        <span className="text-gray-300 ml-2">|</span>
                                        <span className="text-orange-800 font-bold whitespace-nowrap">Heavy: {heavyCount}</span>
                                        <span className="text-gray-300">|</span>
                                        <span className="text-yellow-700 font-bold whitespace-nowrap">Medium: {mediumCount}</span>
                                        <span className="text-gray-300">|</span>
                                        <span className="text-green-700 font-bold whitespace-nowrap">Light: {lightCount}</span>
                                    </>
                                )}
                            </>
                        ) : (
                            <span>Completed: {doneCount}</span>
                        )}
                        </div>
                    )}

                    {isMainBoard && (
                        <div className="relative">
                        <button
                            onClick={(e) => {
                            e.stopPropagation();
                            setActiveProjectColorPickerId(activeProjectColorPickerId === project.id ? null : project.id);
                            }}
                            className="p-1.5 hover:bg-gray-200/50 rounded-full text-gray-400 hover:text-gray-600 transition-all"
                            title="Project Color"
                        >
                            <Palette size={14} />
                        </button>
                        {activeProjectColorPickerId === project.id && (
                            <ColorPicker
                                onSelect={(c) => handleUpdateProjectColor(project.id, c)}
                                onClose={() => setActiveProjectColorPickerId(null)}
                                type="bg"
                            />
                        )}
                        </div>
                    )}
                </div>

                {isMainBoard && (
                    <div className="flex items-center gap-2">
                    <button
                        onClick={() => openNewTaskModal(project.id)}
                        className="text-xs bg-white/80 border border-gray-300 hover:border-blue-400 hover:text-blue-600 px-3 py-1.5 rounded-md transition-all flex items-center gap-1 font-medium"
                    >
                        <Plus size={14} /> Add Task
                    </button>
                    <button
                        onClick={(e) => {
                            e.stopPropagation();
                            deleteProject(project.id);
                        }}
                        className="p-1.5 hover:bg-red-100 text-gray-400 hover:text-red-500 rounded-md transition-all"
                        title="Delete Project"
                    >
                        <Trash2 size={14} />
                    </button>
                    </div>
                )}
                </div>

                {!isCollapsed && (
                    <div className={gridClass}>
                    {columns.map((col, idx) => (
                        <div key={idx} className={`p-4 ${idx % 2 === 0 ? 'bg-white/30' : 'bg-white/10'}`}>
                        <div className="min-h-[50px]">
                            <KanbanColumn
                            title={col.title}
                            status={col.status}
                            color="hidden"
                            tasks={project.tasks.filter(t => {
                                let match = false;
                                if (col.status === 'delayed') {
                                    match = true;
                                } else {
                                    match = col.statuses.includes(t.status);
                                }
                                if (match && searchQuery) {
                                    match = t.name.toLowerCase().includes(searchQuery.toLowerCase()) || 
                                            (t.assignee && t.assignee.toLowerCase().includes(searchQuery.toLowerCase()));
                                }
                                return match;
                            })}
                            onDropTask={updateTaskStatus}
                            onEditTask={isMainBoard ? openEditTaskModal : navigateToTask} 
                            onDeleteTask={deleteTask}
                            onStatusChange={updateTaskStatus}
                            onColorChange={updateTaskColor}
                            projectId={project.id}
                            activeColorPickerId={activeTaskColorPickerId}
                            setActiveColorPickerId={setActiveTaskColorPickerId}
                            onQuickAdd={handleQuickAddTask}
                            onDropOnTask={handleDropOnTask}
                            isLast={idx === columns.length - 1}
                            />
                        </div>
                        </div>
                    ))}
                    </div>
                )}
            </div>
            );
        };

        return (
            <div className="flex flex-col h-screen w-full bg-gray-50 font-sans text-gray-900">
            <header className="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-20 shrink-0">
                <div className="flex items-center gap-8">
                <h1 className="text-xl font-black text-gray-800 tracking-wider flex items-center gap-2">
                    Kanban Board v27
                </h1>

                <nav className="flex gap-1 bg-gray-100/50 p-1 rounded-lg">
                    <button 
                    onClick={() => setCurrentView('dashboard')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView === 'dashboard' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'}`}
                    >
                    <LayoutDashboard size={16} /> Dashboard
                    </button>
                    <button 
                    onClick={() => setCurrentView('ongoing')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView === 'ongoing' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'}`}
                    >
                    <KanbanSquare size={16} /> Ongoing
                    </button>
                    <button 
                    onClick={() => setCurrentView('completed')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView === 'completed' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'}`}
                    >
                    <Check size={16} /> Completed
                    </button>
                </nav>
                </div>

                <div className="flex items-center gap-4">
                <div className="relative hidden md:block">
                    <Search size={16} className="absolute left-3 top-2.5 text-gray-400" />
                    <input 
                    type="text" 
                    placeholder="Search tasks..." 
                    className="pl-9 pr-4 py-2 bg-gray-100 rounded-full text-xs focus:bg-white focus:ring-2 focus:ring-blue-100 border border-transparent focus:border-blue-200 outline-none transition-all w-48"
                    value={searchQuery}
                    onChange={e => setSearchQuery(e.target.value)}
                    />
                </div>

                <div className="h-6 w-px bg-gray-200 mx-1"></div>
                
                {/* Import/Export */}
                <div className="flex items-center gap-2">
                    <input 
                    type="file" 
                    accept=".csv" 
                    className="hidden" 
                    ref={fileInputRef}
                    onChange={(e) => handleImportCSV(e)}
                    />
                    <div className="flex bg-gray-100 rounded-lg p-1">
                    <button 
                        onClick={() => exportToCSV(projects)}
                        className="p-1.5 hover:bg-white rounded-md text-gray-500 hover:text-blue-600 transition-all shadow-sm"
                        title="Export CSV"
                    >
                        <Download size={16} />
                    </button>
                    <button 
                        onClick={() => fileInputRef.current?.click()}
                        className="p-1.5 hover:bg-white rounded-md text-gray-500 hover:text-blue-600 transition-all shadow-sm"
                        title="Import CSV"
                    >
                        <Upload size={16} />
                    </button>
                    </div>

                    <button 
                    onClick={() => setIsProjectModalOpen(true)}
                    className="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all"
                    title="Add New Project"
                    >
                    <Plus size={16} /> <span className="hidden lg:inline">Project</span>
                    </button>
                </div>
                </div>
            </header>

            <main className="flex-1 overflow-hidden bg-gray-50 relative" onClick={() => { setActiveTaskColorPickerId(null); setActiveProjectColorPickerId(null); }}>
                {currentView === 'dashboard' && renderDashboard()}

                {currentView === 'ongoing' && (
                <div className="h-full overflow-y-auto p-6 space-y-8">
                    <div className="flex justify-between items-center mb-2 px-4">
                        {/* ALIGNMENT FIX: Added ml-4 and border-l-4 border-transparent to match Project Row Indent */}
                        <div className="grid grid-cols-2 divide-x divide-transparent w-full border-l-4 border-transparent ml-4">
                            <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2 pl-4"><div className="w-2 h-2 rounded-full bg-blue-500"></div> To Do</h4>
                            <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2 pl-4"><div className="w-2 h-2 rounded-full bg-yellow-500"></div> In Progress</h4>
                        </div>
                        {/* Global Collapse Toggle */}
                        <button onClick={toggleCollapseAll} className="ml-4 text-xs font-bold text-blue-600 hover:text-blue-800 whitespace-nowrap">
                            Collapse / Expand All
                        </button>
                    </div>
                    {projects.map(project => {
                    const hasMatchingTasks = project.tasks.some(t => 
                        t.name.toLowerCase().includes(searchQuery.toLowerCase()) || 
                        (t.assignee && t.assignee.toLowerCase().includes(searchQuery.toLowerCase()))
                    );
                    if (searchQuery && !hasMatchingTasks) return null;

                    return renderProjectRow(project, [
                        { title: '', status: 'todo', statuses: ['todo'] },
                        { title: '', status: 'wip', statuses: ['wip'] }
                    ]);
                    })}

                    {projects.length === 0 && (
                    <div className="text-center py-20 text-gray-400">
                        <p>No projects found. Click "+ Project" to start.</p>
                    </div>
                    )}
                </div>
                )}

                {currentView === 'completed' && (
                <div className="h-full overflow-y-auto p-6 space-y-8">
                    <div className="grid grid-cols-2 gap-4 mb-2 px-4 border-l-4 border-transparent ml-4">
                        <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-green-500"></div> Completed</h4>
                        <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-red-500"></div> Cancelled</h4>
                    </div>
                    {projects.map(project => {
                    const hasCompleted = project.tasks.some(t => t.status === 'done' || t.status === 'cancel');
                    if (!hasCompleted) return null;

                    return renderProjectRow(project, [
                        { title: '', status: 'done', statuses: ['done'] },
                        { title: '', status: 'cancel', statuses: ['cancel'] }
                    ]);
                    })}
                </div>
                )}
            </main>

            <div className="fixed bottom-2 right-2 text-[10px] text-gray-300">v27.0</div>

            <TaskModal 
                isOpen={isModalOpen} 
                onClose={() => setIsModalOpen(false)}
                task={editingTask}
                onSave={handleSaveTask}
            />

            <ProjectModal
                isOpen={isProjectModalOpen}
                onClose={() => setIsProjectModalOpen(false)}
                onSave={handleAddProject}
            />
            </div>
        );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
